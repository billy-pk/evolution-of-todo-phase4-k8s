# Kubernetes Resources Contract

**Feature**: 004-kubernetes-deployment
**Date**: 2025-12-24

## Overview

This contract defines the Kubernetes resource specifications generated by Helm templates.

## 1. Deployment Resources

### Backend Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-todo-backend
  labels:
    app: ai-todo-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-todo-backend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: ai-todo-backend
    spec:
      containers:
      - name: backend
        image: ai-todo-backend:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: ai-todo-backend-secrets
              key: DATABASE_URL
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: ai-todo-backend-secrets
              key: OPENAI_API_KEY
        - name: MCP_SERVER_URL
          value: "http://ai-todo-mcp-service:8001"
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
```

### MCP Server Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-todo-mcp
  labels:
    app: ai-todo-mcp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-todo-mcp
  template:
    metadata:
      labels:
        app: ai-todo-mcp
    spec:
      containers:
      - name: mcp-server
        image: ai-todo-mcp:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8001
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: ai-todo-mcp-secrets
              key: DATABASE_URL
        resources:
          limits:
            cpu: 250m
            memory: 256Mi
          requests:
            cpu: 125m
            memory: 128Mi
```

---

## 2. Service Resources

### Backend Service (NodePort)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ai-todo-backend-service
spec:
  type: NodePort
  selector:
    app: ai-todo-backend
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
    nodePort: 30081
```

**Access**: `http://<minikube-ip>:30081`

### MCP Server Service (ClusterIP)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ai-todo-mcp-service
spec:
  type: ClusterIP
  selector:
    app: ai-todo-mcp
  ports:
  - protocol: TCP
    port: 8001
    targetPort: 8001
```

**Access**: `http://ai-todo-mcp-service:8001` (internal only)

### Frontend Service (NodePort)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ai-todo-frontend-service
spec:
  type: NodePort
  selector:
    app: ai-todo-frontend
  ports:
  - protocol: TCP
    port: 3000
    targetPort: 3000
    nodePort: 30080
```

**Access**: `http://<minikube-ip>:30080`

---

## 3. ConfigMap Resources

### Backend ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ai-todo-backend-config
data:
  MCP_SERVER_URL: "http://ai-todo-mcp-service:8001"
  BETTER_AUTH_ISSUER: "http://ai-todo-frontend-service:3000"
  BETTER_AUTH_JWKS_URL: "http://ai-todo-frontend-service:3000/api/auth/jwks"
  LOG_LEVEL: "info"
```

---

## 4. Secret Resources

### Backend Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ai-todo-backend-secrets
type: Opaque
data:
  DATABASE_URL: <base64-encoded>
  OPENAI_API_KEY: <base64-encoded>
  BETTER_AUTH_SECRET: <base64-encoded>
```

**Important**: Secrets should be created via `helm install --set` or external secret files, NEVER committed to Git.

---

## 5. Resource Validation Commands

**Check Deployments**:
```bash
kubectl get deployments
kubectl describe deployment ai-todo-backend
```

**Check Pods**:
```bash
kubectl get pods
kubectl logs <pod-name>
kubectl describe pod <pod-name>
```

**Check Services**:
```bash
kubectl get services
kubectl describe service ai-todo-backend-service
```

**Check ConfigMaps/Secrets**:
```bash
kubectl get configmaps
kubectl get secrets
```

**Test Service Endpoints**:
```bash
# Get Minikube IP
minikube ip

# Test backend
curl http://$(minikube ip):30081/health

# Test frontend
curl http://$(minikube ip):30080
```

---

## 6. Resource Limits Summary

| Service | CPU Request | CPU Limit | Memory Request | Memory Limit |
|---------|-------------|-----------|----------------|--------------|
| Backend | 250m | 500m | 256Mi | 512Mi |
| MCP Server | 125m | 250m | 128Mi | 256Mi |
| Frontend | 250m | 500m | 256Mi | 512Mi |
| **Total** | **625m** | **1250m** | **640Mi** | **1280Mi** |

**Minikube Requirements**: 2 CPUs, 4GB RAM (sufficient for all services)

---

## 7. Port Allocation

| Service | Container Port | Service Port | NodePort | Access |
|---------|----------------|--------------|----------|--------|
| Backend | 8000 | 8000 | 30081 | External |
| MCP Server | 8001 | 8001 | N/A | Internal |
| Frontend | 3000 | 3000 | 30080 | External |

---

## 8. Health Check Contracts

All services MUST implement:

**Liveness Probe**:
- Endpoint: `/health` (or equivalent)
- Success: 200 OK
- Failure: Pod restart

**Readiness Probe**:
- Endpoint: `/ready` (or equivalent)
- Success: 200 OK, pod receives traffic
- Failure: Pod removed from service endpoints (no traffic)

---

## Compliance Checklist

- [ ] All Deployments use `imagePullPolicy: IfNotPresent`
- [ ] All Deployments define resource limits and requests
- [ ] All Deployments include liveness and readiness probes
- [ ] All Services have correct selectors matching Deployment labels
- [ ] All Secrets injected via environment variables (not mounted files)
- [ ] All ConfigMaps and Secrets follow naming convention: `<service>-config` / `<service>-secrets`
- [ ] No hard-coded credentials in manifests
- [ ] Rolling update strategy configured for zero-downtime deployments
